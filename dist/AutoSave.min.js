!function(e,t){"function"==typeof define&&define.amd?define(["autosave"],t):"object"==typeof module&&module.exports?module.exports=t(require("autosave")):e.AutoSave=t(e.autosave)}(this,function(){"use strict";function u(e,t){this.__callbacks=void 0,this.__theStore=void 0,this.__getRootControlsFunc=void 0,this.__debounceInterval=void 0,this.__debounceTimeoutHandle=void 0,this.__dataStoreKeyFunc=void 0,this.__onInitialiseInvoked=void 0,this.__pendingInitRoutines=0,this.__pendingInitComplete=!1,this.__invokeExtBound=void 0,this.__resetNotificationDisplayBound=void 0,this.__handleDebouncedEventBound=void 0,this.__onUnloadingBound=void 0,this.__minShowDuration=void 0,this.__warnMsgShowDuration=void 0,this.__currSaveNotificationElement=void 0,this.__currWarnStorageNotificationElement=void 0,this.__saveInProgress=void 0,this.__isPendingSave=void 0,this.__autoToggleState=void 0,this.__warnNoStore=void 0,this.__clearEmptyValuesOnLoad=void 0,u.whenDocReady(this._initialise.bind(this,e,t))}function n(e,t){this._logSink=t,this._logSink(u.LOG_INFO,"Using cookie storage as local store"),navigator.cookieEnabled||this._logSink(u.LOG_WARN,"Cookie Store requested but cookies not enabled."),this.__currStoreKeyFunc=e}function r(e,t){this._logSink=t,this._logSink(u.LOG_INFO,"Using Browser Local Storage as local store"),this.__currStoreKeyFunc=e}function a(e){this._logSink=e,this._logSink(u.LOG_INFO,"Using a no-op data store")}function s(e,t,o,i){if(this._logSink=i,this._logSink(u.LOG_INFO,"Using a custom store as the local store"),2!=o.length)throw new Error("dataStore.load function must take 2 parameters.");if(3!=t.length)throw new Error("dataStore.save function must take 3 parameters.");this.__currStoreKeyFunc=e,this.__userLoadFunc=o,this.__userSaveFunc=t}return u.prototype._initialise=function(e,t){t=t||{};try{this.__isUserInvoked=!0,this.__callbacks=t,this.__resetNotificationDisplayBound=this._resetNotificationDisplay.bind(this),this.__handleDebouncedEventBound=this._handleDebouncedEvent.bind(this),this.__invokeExtBound=this._sendLog.bind(this),this.__onUnloadingBound=this._onUnloading.bind(this),u._ensureOptIn(t,["dataStore","autoSaveTrigger","autoLoadTrigger","seekExternalFormElements","saveNotification","noStorageNotification","onSaveNotification","onNoStorageNotification","onLog","onInitialised","onPreLoad","onPostLoad","onPostDeserialize","onPreSerialize","onPreStore","onPostStore"],"top level"),this._registerInitQueue(1);var o=u._parseExternalElemsArg(t.seekExternalFormElements);this._updateRootControls(e,o),this._updateDataStore(t.dataStore),this._updateAutoSaveStrategy(t.autoSaveTrigger,o),this._updateLoadStrategy(t.autoLoadTrigger),this._updateSaveNotification(t.saveNotification),this.__warnNoStore&&(this._updateNoStorageNotification(t.noStorageNotification),this._toggleNoStorageNotification(!0)),this._hookUnloadListener(!0),this._registerInitQueue(-1)}catch(e){throw this._internalDispose(),e}finally{this.__isUserInvoked=!1}},u.prototype.save=function(){try{this.__isUserInvoked=!0,this._sendLog(u.LOG_INFO,"Executing save : explicitly triggered"),this._executeSave()}finally{this.__isUserInvoked=!1}},u.prototype.load=function(){try{this.__isUserInvoked=!0;var e=null;if(e=this.__callbacks.onPreLoad){this._sendLog(u.LOG_DEBUG,"Invoking callback onPreLoad");var t=e();if(!1===t)return void this._sendLog(u.LOG_INFO,"User aborted the load in the onPreLoad handler");if(void 0!==t&&!0!==t)return this._sendLog(u.LOG_INFO,"User supplied custom payload for loading in the onPreLoad handler"),this._sendLog(u.LOG_DEBUG,"Custom payload",t),void this._loadCallbackHandler(t)}this._registerInitQueue(1),this.__theStore.load(this._pipeErrorsIfAsync.bind(this,this._loadCallbackHandler.bind(this)))}finally{this.__isUserInvoked=!1}},u.prototype.dispose=function(e){try{this.__isUserInvoked=!0,this._internalDispose(e)}finally{this.__isUserInvoked=!1}},u.prototype.resetStore=function(){try{this.__isUserInvoked=!0;this.__theStore.resetStore(function(){})}finally{this.__isUserInvoked=!1}},u.prototype.getCurrentValue=function(){try{this.__isUserInvoked=!0;var e=this._internalGetCurrentValue();return!1===e?null:e}finally{this.__isUserInvoked=!1}},u.prototype._internalDispose=function(e){try{this._hookListeners(!1,null),this._hookUnloadListener(!1)}catch(e){this._sendLog(u.LOG_WARN,"Error unhooking listeners",e)}this.__debounceTimeoutHandle&&(clearTimeout(this.__debounceTimeoutHandle),this.__debounceTimeoutHandle=null);try{if(this.__dataStoreKeyFunc){var t=this.__dataStoreKeyFunc(),o=u.__keysInUse.indexOf(t);-1!=o&&u.__keysInUse.splice(o,1)}}catch(e){this._sendLog(u.LOG_WARN,"Error resetting store",e)}try{!1!==e&&this.resetStore()}catch(e){this._sendLog(u.LOG_WARN,"Error resetting store",e)}var i=this.__currSaveNotificationElement;i&&i.parentNode&&i.parentNode.removeChild(i);var n=this.__currWarnStorageNotificationElement;n&&n.parentNode&&n.parentNode.removeChild(n)},u.prototype._internalGetCurrentValue=function(){var e=this.__getRootControlsFunc(),t=this.__callbacks.onPreSerialize;if(t){this._sendLog(u.LOG_DEBUG,"Invoking callback onPreSerialize");var o=t(e);if(!1===o)return this._sendLog(u.LOG_INFO,"User aborted fetching current-value in the onPreSerialize handler"),!1;void 0===o||!0===o||(e=null===o?(this._sendLog(u.LOG_WARN,"User specified an empty override payload in the onPreSerialize handler"),[]):(this._sendLog(u.LOG_INFO,"User overwrote current-value payload with custom one in the onPreSerialize handler"),this._sendLog(u.LOG_DEBUG,"Custom current-value payload in onPreSerialize handler",o),this._getControlsFromUserInput(o)))}return this._invokeExt(u.serialize,e)},u.prototype._updateLoadStrategy=function(e){if(null!==e){if(void 0!==e)throw new Error("Unexpected type for parameter 'autoLoadtrigger'");this.load()}else this._sendLog(u.LOG_DEBUG,"User requested no auto-load. Skipping...")},u.prototype._pipeErrorsIfAsync=function(e,t){try{var o=u.toArray(arguments,1);e.apply(this,o)}catch(e){if(this.__isUserInvoked)throw e;this._sendLog(u.LOG_ERROR,e)}},u.prototype._loadCallbackHandler=function(e){var t=this.__callbacks.onPostLoad;if(t){this._sendLog(u.LOG_DEBUG,"Invoking callback onPostLoad");var o=t(e);if(!1===o)return this._sendLog(u.LOG_INFO,"User aborted the load in the onPostLoad handler"),void this._registerInitQueue(-1);void 0===o||!0===o||(this._sendLog(u.LOG_INFO,"User overwrote loading payload with custom one for loading in the onPostLoad handler"),this._sendLog(u.LOG_DEBUG,"Custom load payload",o),e=o)}var i=this.__getRootControlsFunc();this._invokeExt(u.deserialize,i,e,this.__clearEmptyValuesOnLoad),(t=this.__callbacks.onPostDeserialize)&&(this._sendLog(u.LOG_DEBUG,"Invoking callback onPostDeserialize"),t()),this._registerInitQueue(-1)},u.prototype._registerInitQueue=function(e){if(!this.__pendingInitComplete&&(this.__pendingInitRoutines+=e,0==this.__pendingInitRoutines)){var t=this.__callbacks.onInitialised;t&&(this.__pendingInitComplete=!0,this._sendLog(u.LOG_DEBUG,"Invoking callback onInitialised"),t())}},u.prototype._saveStartFinally=function(e){this._toggleSavingNotification(e),!(this.__saveInProgress=e)&&this.__isPendingSave&&(this.__isPendingSave=!1,this._executeSave())},u.prototype._toggleNoStorageNotification=function(e){var t=this.__callbacks.onNoStorageNotification;if(t){var o=t(e);if(!1===o)return void this._sendLog(u.LOG_INFO,"User aborted toggle no-storage bar");if(void 0!==o&&!0!==o)throw new Error("Unexpected return type from callback 'onNoStorageNotification'")}e?(this._toggleSaveElementVisibility(this.__currWarnStorageNotificationElement,!0),setTimeout(this._pipeErrorsIfAsync.bind(this,this._toggleNoStorageNotification.bind(this,!1)),this.__warnMsgShowDuration)):this._toggleSaveElementVisibility(this.__currWarnStorageNotificationElement,!1)},u.prototype._toggleSavingNotification=function(e){var t=this.__callbacks.onSaveNotification;if(t){var o=t(e);if(!1===o)return void this._sendLog(u.LOG_INFO,"User aborted toggle save bar");if(void 0!==o&&!0!==o)throw new Error("Unexpected return type from callback 'onSaveNotification'")}e?(this._toggleSaveElementVisibility(this.__currSaveNotificationElement,!0),this.__autoToggleState=null,setTimeout(this.__resetNotificationDisplayBound,this.__minShowDuration)):null===this.__autoToggleState?this.__autoToggleState=!0:this._toggleSaveElementVisibility(this.__currSaveNotificationElement,!1)},u.prototype._resetNotificationDisplay=function(){1==this.__autoToggleState?this._toggleSaveElementVisibility(this.__currSaveNotificationElement,!1):this.__autoToggleState=!1},u.prototype._toggleSaveElementVisibility=function(e,t){if(e){var o=t?e.getAttribute("autosave-od")||"block":"none";e.style.display=o}else this._sendLog(u.LOG_DEBUG,"No element found to toggle notification element visibility. Notification will not show/hide.")},u.prototype._updateNoStorageNotification=function(e){var t=u.cloneObj(u.DEFAULT_AUTOSAVE_WARN);if(null===e)this._sendLog(u.LOG_DEBUG,"User requested no storage-warning notification bar. Skipping creation..."),this.__currWarnStorageNotificationElement=null;else if(void 0===e)this.__currWarnStorageNotificationElement=u._createNotification(t,null),this.__warnMsgShowDuration=t.duration;else{u._ensureOptIn(e,["template","message","showDuration"],"noStorageNotification");var o=e.template,i=e.message,n=e.showDuration;if(void 0!==n){if("number"!=typeof n)throw new Error("Unexpected non-numeric type for parameter 'showDuration'");if(n<=60)throw new Error("The 'showDuration' must be specified in milliseconds");this.__warnMsgShowDuration=n,this._sendLog(u.LOG_INFO,"Warning notification duration initialised with custom interval",this.__warnMsgShowDuration)}else this.__warnMsgShowDuration=t.duration;if(o&&i)throw new Error("Only 1 of noStorageNotification.template or noStorageNotification.message can be set - not both");this.__currWarnStorageNotificationElement=i?(t.msg=i,this._sendLog(u.LOG_DEBUG,"Warn Storage Notification bar with customised msg created."),u._createNotification(t,null)):o?(t.msg=null,this._sendLog(u.LOG_DEBUG,"Warn Storage Notification bar with customised template created."),u._createNotification(t,o)):u._createNotification(t,null)}},u.prototype._updateSaveNotification=function(e){var t=u.cloneObj(u.DEFAULT_AUTOSAVE_SHOW);if(null===e)this._sendLog(u.LOG_DEBUG,"User requested no saving notification bar. Skipping creation..."),this.__currSaveNotificationElement=null;else if(void 0===e)this.__currSaveNotificationElement=u._createNotification(t,null),this.__minShowDuration=t.duration;else{u._ensureOptIn(e,["template","message","minShowDuration"],"saveNotification");var o=e.template,i=e.message,n=e.minShowDuration;if(void 0!==n){if("number"!=typeof n)throw new Error("Unexpected non-numeric type for parameter 'minShowDuration'");if(n<=60)throw new Error("The 'minShowDuration' must be specified in milliseconds");this.__minShowDuration=n,this._sendLog(u.LOG_INFO,"Saving Min duration initialised with custom interval",this.__minShowDuration)}else this.__minShowDuration=t.duration;if(o&&i)throw new Error("Only 1 of saveNotification.template or saveNotification.message can be set - not both");this.__currSaveNotificationElement=i?(t.msg=i,this._sendLog(u.LOG_DEBUG,"Saving Notification bar with customised msg created."),u._createNotification(t,null)):o?(t.msg=null,this._sendLog(u.LOG_DEBUG,"Saving Notification bar with customised template created."),u._createNotification(t,o)):u._createNotification(t,null)}},u.prototype._executeSave=function(){if(this.__saveInProgress)return this._sendLog(u.LOG_DEBUG,"Save was postponed as one already in progress (If unexpected, did you remember to invoke the saveComplete callback?)"),void(this.__isPendingSave=!0);try{this._saveStartFinally(!0);var e=this._internalGetCurrentValue();if(!1===e)return this._sendLog(u.LOG_INFO,"User aborted the save in the onPreSerialize handler"),void this._saveStartFinally(!1);e=this.__theStore.mouldForOutput(e);var t=this.__callbacks.onPreStore;if(t){this._sendLog(u.LOG_DEBUG,"Invoking callback onPreStore");var o=t(e);if(!1===o)return this._sendLog(u.LOG_INFO,"User aborted the save in the onPreStore handler"),void this._saveStartFinally(!1);void 0===o||!0===o||(this._sendLog(u.LOG_INFO,"User overwrote saving payload with custom one in the onPreStore handler"),this._sendLog(u.LOG_DEBUG,"Custom save payload in onPreStore handler",o),e=o)}this.__theStore.save(e,this._onSaveCompleted.bind(this))}catch(e){throw this._saveStartFinally(!1),e}},u.prototype._onSaveCompleted=function(){try{var e=this.__callbacks.onPostStore;e&&(this._sendLog(u.LOG_DEBUG,"Invoking callback onPostStore"),e())}finally{this._saveStartFinally(!1)}},u.prototype._updateDataStore=function(e){var t=u.isLocalStorageAvailable(),o=u.isCookieStorageAvailable();this._sendLog(u.LOG_DEBUG,"Has Local Storage: ",t,", Has Cookie Storage: ",o);var i=this.__getRootControlsFunc();if(this.__dataStoreKeyFunc=this._invokeExt(u._getKeyFunc,i,e?e.key:void 0),void 0===e)this.__theStore=t?new r(this.__dataStoreKeyFunc,this.__invokeExtBound):o?new n(this.__dataStoreKeyFunc,this.__invokeExtBound):(this.__warnNoStore=!0,new a(this.__invokeExtBound));else if(null===e)this.__theStore=new a(this.__invokeExtBound);else{if("object"!=typeof e)throw new Error("Unexpected type of parameter 'dataStore'");if(u._ensureOptIn(e,["save","load","key","preferCookies","clearEmptyValuesOnLoad"],"dataStore"),this.__clearEmptyValuesOnLoad=e.clearEmptyValuesOnLoad,void 0===e.load&&void 0===e.save)o&&!0===e.preferCookies?this.__theStore=new n(this.__dataStoreKeyFunc,this.__invokeExtBound):this.__theStore=t?new r(this.__dataStoreKeyFunc,this.__invokeExtBound):o?new n(this.__dataStoreKeyFunc,this.__invokeExtBound):(this.__warnNoStore=!0,new a(this.__invokeExtBound));else if(null===e.load&&null===e.save)this.__theStore=new a(this.__invokeExtBound);else{if("function"!=typeof e.load||"function"!=typeof e.save)throw new Error("The dataStore.load and dataStore.save parameters must 1) both be set or both be unset and 2) must be functions.");this.__theStore=this._invokeExt(u.getCtor(s,this.__dataStoreKeyFunc,e.save,e.load,this.__invokeExtBound))}}},u.prototype._invokeExt=function(e,t){var o=u.log;try{u.log=this.__invokeExtBound;var i=u.toArray(arguments,1);return e.apply(null,i)}finally{u.log=o}},u.prototype._sendLog=function(e,t){var o,i=this.__callbacks.onLog;if(i){var n,r;if("function"==typeof i)n=i,r=arguments;else{if("object"!=typeof i)throw new Error("Unexpected type of callback parameter 'dataStore'");if(!(n=i[e]))return;r=u.toArray(arguments,1)}var a=n.apply(this,r);if(!1===a)return;o=void 0===a||!0===a?arguments:a&&a.length?[e].concat(a):[e,a]}else o=arguments;u._logToConsole.apply(this,o)},u.prototype._onUnloading=function(e){this.__debounceTimeoutHandle&&this._handleDebouncedEvent()},u.prototype._updateAutoSaveStrategy=function(e,t){if(null!==e){if(void 0===e)this.__debounceInterval=u.DEFAULT_AUTOSAVE_INTERVAL,this._sendLog(u.LOG_INFO,"Auto-Save trigger was initialised with default interval",this.__debounceInterval);else{if("object"!=typeof e)throw new Error("Unexpected type for parameter 'autoSaveTrigger'");u._ensureOptIn(e,["debounceInterval"],"autoSaveTrigger");var o=e.debounceInterval;if("number"!=typeof o)throw new Error("Unexpected non-numeric type for parameter 'debounceInterval'");if(o<=60)throw new Error("The 'debounceInterval' must be specified in milliseconds");this.__debounceInterval=o,this._sendLog(u.LOG_INFO,"Auto-Save trigger was initialised with custom interval",this.__debounceInterval)}this._hookListeners(!0,t)}else this._sendLog(u.LOG_INFO,"Auto-Save trigger was disabled")},u.prototype._updateRootControls=function(n,r){if(n||(this._sendLog(u.LOG_DEBUG,"No parent element specified - will use whole document"),n=document.body),"function"==typeof n)this.__getRootControlsFunc=function(){var e=n();if(e){var t=this._getControlsFromUserInput(e);if(this._sendLog(u.LOG_INFO,"Extracted "+t.length+" root level controls from user specified input"),r){var o=this._invokeExt(u.getExternalFormControls,t);this._sendLog(u.LOG_INFO,"Found "+o.length+" external form-linked controls");for(var i=0;i<o.length;i++)t.push(o[i])}return t}return this._sendLog(u.LOG_INFO,"User specified custom function returned empty set of elements"),[]};else{var e=this._getControlsFromUserInput(n);if(Array.isArray(n)||0!=e.length?this._sendLog(u.LOG_INFO,"Extracted "+e.length+" root level controls"):this._sendLog(u.LOG_WARN,"RootControls parameter resolved to zero elements - maybe your selector(s) werent right?"),r){var t=this._invokeExt(u.getExternalFormControls,e);this._sendLog(u.LOG_INFO,"Found "+t.length+" external form-linked controls");for(var o=0;o<t.length;o++)e.push(t[o])}this.__getRootControlsFunc=function(){return e}}},u.prototype._hookUnloadListener=function(e){e?window.addEventListener("beforeunload",this.__onUnloadingBound):window.removeEventListener("beforeunload",this.__onUnloadingBound)},u.prototype._hookListeners=function(e,t){this._sendLog(u.LOG_DEBUG,(e?"Hooking":"Unhooking")+" listeners. Seeking external controls for hooking: "+t);for(var o=this.__getRootControlsFunc(),i=0;i<o.length;i++){var n=o[i];this._hookSingleControl(n,e)}},u.prototype._hookSingleControl=function(e,t){t?(e.addEventListener("input",this,u.__defaultListenOpts),e.addEventListener("change",this,u.__defaultListenOpts)):(e.removeEventListener("input",this,u.__defaultListenOpts),e.removeEventListener("change",this,u.__defaultListenOpts))},u.prototype.handleEvent=function(e){this._sendLog(u.LOG_DEBUG,"Handling raw control input event",e),this.__debounceTimeoutHandle||(this.__debounceTimeoutHandle=setTimeout(this.__handleDebouncedEventBound,this.__debounceInterval))},u.prototype._handleDebouncedEvent=function(){this._sendLog(u.LOG_DEBUG,"Handling debounced control input event"),this._sendLog(u.LOG_INFO,"Executing save: after element(s) changed"),this.__debounceTimeoutHandle=null,this._pipeErrorsIfAsync.call(this,this._executeSave)},u.prototype._getControlsFromUserInput=function(e){var t;if("string"==typeof e){var o=document.querySelectorAll(e);t=[];for(var i=0;i<o.length;i++)t.push(o[i])}else if(void 0!==e.length)t=e;else{if(!(0<e.nodeType))throw new Error("Unrecognized type of HTML element(s) supplied. Expected a selector, array-like object or a single Node.",e);t=[e]}return t},n.prototype.load=function(e){var t=this.__currStoreKeyFunc(),o=new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$");e(document.cookie.replace(o,"$1")||null)},n.prototype.save=function(e,t){var o=this.__currStoreKeyFunc();if(!o)throw new Error("No key specified for saving to cookie");e=null===e?u._buildFullCookieStr(o,"",{expireNow:!0}):u._buildFullCookieStr(o,e,{dataIsFullCookie:!0}),document.cookie=e,t()},n.prototype.mouldForOutput=function(e){this.__currStoreKeyFunc();var t=u._buildFullCookieStr(null,e,{neverExpire:!0});return this._logSink(u.LOG_DEBUG,"Created cookie params string",t),t},n.prototype.resetStore=function(e){return this.save(null,e)},r.prototype.load=function(e){var t=this.__currStoreKeyFunc();e(localStorage.getItem(t))},r.prototype.save=function(e,t){var o=this.__currStoreKeyFunc();if(!o)throw new Error("No key specified for saving to local storage");null===e?localStorage.removeItem(o):localStorage.setItem(o,e),t()},r.prototype.mouldForOutput=function(e){return e},r.prototype.resetStore=function(e){return this.save(null,e)},a.prototype.load=function(e){e(null)},a.prototype.save=function(e,t){t()},a.prototype.mouldForOutput=function(e){return e},a.prototype.resetStore=function(){},s.prototype.load=function(e){var t=this.__currStoreKeyFunc();return this.__userLoadFunc(t,e)},s.prototype.save=function(e,t){var o=this.__currStoreKeyFunc();return this.__userSaveFunc(o,e,t)},s.prototype.mouldForOutput=function(e){return e},s.prototype.resetStore=function(e){return this.save(null,e)},u._ensureOptIn=function(e,t,o){var i=Object.keys(e);for(var n in i){var r=i[n];if(-1==t.indexOf(r))throw new Error("Unexpected parameter '"+r+"' in "+o+" options object")}},u.whenDocReady=function(e){if("complete"==document.readyState)e();else var t=setInterval(function(){"complete"==document.readyState&&(clearInterval(t),e(),u.log(u.LOG_DEBUG,"Document was late initialised - completed AutoSave initialisation sequence"))},u.DEFAULT_LOAD_CHECK_INTERVAL)},u._getKeyFunc=function(e,t){var o=u.DEFAULT_KEY_PREFIX+u.getUrlPath();if(void 0!==t){if("string"==typeof t){var i=o+"_"+t;return u.log(u.LOG_INFO,"Using static provided value for datastore key",i),function(){return i}}if("function"==typeof t)return u.log(u.LOG_DEBUG,"Using user-supplied function for generating datastore key when required"),function(){var e=o+"_"+t();return u.log(u.LOG_DEBUG,"Calculated dynamic datastore key to use",e),e};throw new Error("Unexpected type of parameter 'dataStore.key'")}var n=null;if("FORM"==e.nodeName?n=e.name:1==e.length&&"FORM"==e[0].nodeName&&(n=e[0].name),u.log(u.LOG_INFO,"Using calculated value for datastore key",n=n?o+"_"+n:o),-1!=u.__keysInUse.indexOf(n))throw new Error("There is already an AutoSave instance with the storage key of '"+n+"'. See the documentation for solutions.");return u.__keysInUse.push(n),u.log(u.LOG_DEBUG,"Updated set of keys in use",u.__keysInUse),function(){return n}},u.deserialize=function(e,t,o){if(t){void 0===o&&(o=!0);for(var i=u._decodeFieldDataFromString(t),n=0;n<e.length;n++){var r=e[n];u._deserializeSingleControl(r,i,o)}}},u.serialize=function(e){for(var t=[[],[]],o=0;o<e.length;++o)u._serializeSingleControl(e[o],t);return u._encodeFieldDataToString(t)},u._serializeSingleControl=function(e,t){var o,i,n=e.name,r=e.value;if("INPUT"==e.nodeName){if(!n)return void u.log(u.LOG_DEBUG,"Ignored INPUT node as no name was present",e);"radio"==e.type||"checkbox"==e.type?e.checked&&(t[0].push(n),t[1].push(r)):(t[0].push(n),t[1].push(r))}else if("SELECT"==e.nodeName){if(!n)return void u.log(u.LOG_DEBUG,"Ignored SELECT node as no name was present",e);if("select-one"==e.type)t[0].push(n),t[1].push(r);else for(o=e.options,i=0;i<o.length;++i)o[i].selected&&(t[0].push(n),t[1].push(o[i].value))}else if("TEXTAREA"==e.nodeName){if(!n)return void u.log(u.LOG_DEBUG,"Ignored TEXTAREA node as no name was present",e);t[0].push(n),t[1].push(r)}else for(o=e.children,i=0;i<o.length;i++)u._serializeSingleControl(o[i],t)},u._encodeFieldDataToString=function(e){var t="";for(var o in e[0]){var i=e[0][o],n=e[1][o];t+=encodeURIComponent(i)+"="+encodeURIComponent(n),o!=e[0].length-1&&(t+="&")}return t=t.replace(/%20/g,"+")},u._decodeFieldDataFromString=function(e){var t=[[],[]],o=(e=e.replace(/\+/g,"%20")).split("&");for(var i in o){var n=o[i],r=n.split("=");if(2!=r.length)u.log(u.LOG_WARN,"Expected a pair of items separated by '=' in "+n+". Got "+r.length+". Ignoring...");else{var a=decodeURIComponent(r[0]),s=decodeURIComponent(r[1]);t[0].push(a),t[1].push(s)}}return t},u.addSerialisedValue=function(e,t,o){if(!t)throw new Error("No key specified");return null==o&&(o=""),e||(e=""),e.length&&(e+="&"),e+=u._encodeFieldDataToString([[t],[o]])},u.getSerialisedValues=function(e,t){if(!t)throw new Error("No key specified");if(!e)return[];var o=u._decodeFieldDataFromString(e),i=[];for(var n in o[0])o[0][n]==t&&i.push(o[1][n]);return i},u._deserializeSingleControl=function(e,t,o){var i,n,r,a=!1;if("INPUT"==e.nodeName)if("radio"==e.type||"checkbox"==e.type){var s=null;for(i in t[0])if(t[0][i]==e.name){if(t[1][i]==e.value){s=!0;break}s=!1}!0===s?e.checked=!0:!1===s&&o&&(e.checked=!1)}else a=!0;else if("SELECT"==e.nodeName){r=e.options;e:for(var l=0;l<r.length;l++){var _=r[l];for(i in t[0])if(t[0][i]==e.name&&(n=t[1][i])==_.value){if((""!==n||o)&&(_.selected=!0),"select-one"==e.type)break e;break}}}else if("TEXTAREA"==e.nodeName)a=!0;else{r=e.children;for(var d=0;d<r.length;d++)u._deserializeSingleControl(r[d],t,o)}if(a)for(i in t[0]){if(t[0][i]===e.name){(""!==(n=t[1][i])||o)&&(e.value=n);break}}},u._parseExternalElemsArg=function(e){if(void 0===e)e=!0;else if(!1!==e&&!0!==e)throw new Error("Unexpected type for parameter 'seekExternalFormElements'");return e},u.isLocalStorageAvailable=function(){var t;if(void 0===u.__cachedLocalStorageAvailable)try{t=window.localStorage;var e="__ASJS_test__";t.setItem(e,"_"),t.removeItem(e),u.__cachedLocalStorageAvailable=!0}catch(e){u.__cachedLocalStorageAvailable=e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}return u.__cachedLocalStorageAvailable},u.isCookieStorageAvailable=function(){return void 0===u.__cachedCookiesAvailable&&(navigator.cookieEnabled?u.__cachedCookiesAvailable=!0:(document.cookie="AutoSave_cookietest=1",u.__cachedCookiesAvailable=-1!=document.cookie.indexOf("AutoSave_cookietest="),document.cookie="AutoSave_cookietest=1; expires=Thu, 01-Jan-1970 00:00:01 GMT")),u.__cachedCookiesAvailable},u._uniq=function(e,t,o){return o.indexOf(e)===t},u._buildFullCookieStr=function(e,t,o){if(e&&/(?:expires|max\-age|path|domain|secure)/i.test(e))throw new Error("Parameters to cookies(expires, path, domain etc.) must not be specified as part of the key");o=o||{};var i=(e?encodeURIComponent(e)+"=":"")+t;return o.dataIsFullCookie||(i+="; ",o.neverExpire?i+="expires=Fri, 31 Dec 2100 23:59:59 GMT; ":o.expireNow&&(i+="expires=Sat, 23 Mar 1889 23:59:59 GMT; ")),i},u.resetAll=function(){var e;if(u.__keysInUse=[],u.isLocalStorageAvailable())for(var t=localStorage.length-1;0<=t;t--)(e=localStorage.key(t))&&0===e.indexOf(u.DEFAULT_KEY_PREFIX)&&localStorage.removeItem(e);for(var o=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),i=0;i<o.length;i++)if(0===(e=decodeURIComponent(o[i])).indexOf(u.DEFAULT_KEY_PREFIX)){var n=u._buildFullCookieStr(e,"",{expireNow:!0});document.cookie=n}},u.getExternalFormControls=function(e){for(var t,o,i=[],n=0;n<e.length;n++){var r=e[n];if("FORM"==r.nodeName)(t=r.id)&&i.push(t);else for(var a=r.querySelectorAll("form"),s=0;s<a.length;s++){var l=a[s];"FORM"==l.nodeName&&(t=l.id)&&i.push(t)}}if((i=i.filter(u._uniq)).length){var _="[form='"+i.join("'],[form='")+"']";u.log(u.LOG_DEBUG,"Querying for external form controls with selector",_),o=document.querySelectorAll(_)}else o=[];return o},u.getCtor=function(t,e){var o=u.toArray(arguments,1);return function(){var e=[null].concat(o);return new(t.bind.apply(t,e))}},u.toArray=function(e,t){for(var o=[],i=0;i<e.length;i++)o.push(e[i]);return t&&(o=o.slice(t)),o},u._logToConsole=function(e,t){var o=u.toArray(arguments,1);if(e==u.LOG_DEBUG)console.debug?console.debug.apply(console,o):console.log.apply(console,o);else if(e==u.LOG_INFO)console.info.apply(console,o);else if(e==u.LOG_WARN)console.warn.apply(console,o);else{if(e!=u.LOG_ERROR)throw new Error("Unknown log level: "+e);console.error.apply(console,o)}},u._createNotification=function(e,t){var o;if(t){var i=document.createElement("div");if(i.innerHTML=t,1!=i.children.length)throw new Error("Expected exactly 1 top-level element in saveNotification.template");o=i.children[0]}else(o=document.createElement("div")).classList.add("autosave-ctr"),o.classList.add("autosave-"+e.type),u._styleNotificationElem(o),e.bg&&(o.style.backgroundColor=e.bg),e.marginLeft&&(o.style.marginLeft=e.marginLeft),o.innerHTML="<span class='autosave-msg'>"+e.msg+"</span>";return"none"==o.style.display&&u.log(u.LOG_WARN,"Notification HTML template should not have a display style of 'none' or it'll never show"),o.setAttribute("autosave-od",o.style.display),o.style.display="none",document.body.appendChild(o),o},u._styleNotificationElem=function(e){var t=e.style;t.position="fixed",t.top="5px",t.left="50%",t.border="1px solid #aba8a8",t.padding="1px 30px",t.borderRadius="4px",t.color="#484848",t.fontSize="0.8em"},u.cloneObj=function(e){var t={};for(var o in e)t[o]=e[o];return t},u.getUrlPath=function(){return window.location.pathname},u.LOG_DEBUG="debug",u.LOG_INFO="info",u.LOG_WARN="warn",u.LOG_ERROR="error",u.DEFAULT_LOAD_CHECK_INTERVAL=100,u.DEFAULT_AUTOSAVE_INTERVAL=3e3,u.DEFAULT_AUTOSAVE_SHOW={duration:500,msg:"Saving...",type:"saving",bg:"#f2f9ff",marginLeft:"-20px"},u.DEFAULT_AUTOSAVE_WARN={duration:5e3,msg:"AutoSave is turned off - no datastore available to store input data.",type:"noStore",bg:"#ff9b74",marginLeft:"-240px"},u.DEFAULT_KEY_PREFIX="AutoSaveJS_",u.log=u._logToConsole,u.__keysInUse=[],u.__defaultListenOpts={passive:!0,capture:!0},u.__cachedLocalStorageAvailable=void 0,u.__cachedCookiesAvailable=void 0,u.version="1.0.0",u});
//# sourceMappingURL=AutoSave.js.map